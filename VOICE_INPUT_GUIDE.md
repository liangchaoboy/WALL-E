# 语音输入导航指南

本文档详细说明如何通过语音输入实现地图导航。

---

## 🎤 语音输入架构

### 系统架构图

```
┌─────────────────┐
│   用户语音输入   │ "帮我从北京到上海导航"
└────────┬────────┘
         │
         ↓
┌─────────────────────────────┐
│   AI 助手 (Claude Desktop)   │
│  ┌──────────────────────┐   │
│  │   语音识别 (STT)      │   │ 语音 → 文字
│  └──────────┬───────────┘   │
│             ↓                │
│  ┌──────────────────────┐   │
│  │   自然语言理解 (NLU)  │   │ 理解意图
│  └──────────┬───────────┘   │
│             ↓                │
│  ┌──────────────────────┐   │
│  │   MCP 工具调用        │   │ 调用我们的服务
│  └──────────┬───────────┘   │
└─────────────┼───────────────┘
              │
              ↓
┌─────────────────────────────┐
│   QWall2 MCP 服务器          │
│  ┌──────────────────────┐   │
│  │ parse_navigation_    │   │ 解析文本
│  │ intent               │   │ "北京" → "上海"
│  └──────────┬───────────┘   │
│             ↓                │
│  ┌──────────────────────┐   │
│  │ navigate_map         │   │ 生成 URL
│  └──────────┬───────────┘   │
└─────────────┼───────────────┘
              │
              ↓
┌─────────────────────────────┐
│   浏览器 + 地图服务          │
│   显示导航路线               │
└─────────────────────────────┘
```

---

## 🔧 技术实现

### 1. 语音识别 (STT)

**由 AI 助手负责：**
- Claude Desktop 内置语音识别
- 支持多种语言（包括中文）
- 实时转换语音为文字

**我们不需要实现：**
- ✅ STT 引擎由 Claude 提供
- ✅ 麦克风访问由 Claude 管理
- ✅ 语音降噪由 Claude 处理

### 2. 自然语言解析

**由我们的 MCP 服务器负责：**

```go
// pkg/parser/parser.go

func ParseNavigationIntent(text string) NavigationIntent {
    // 支持的语音转文字后的模式
    var navigationPatterns = []*regexp.Regexp{
        // "从 A 到 B" 模式
        regexp.MustCompile(`(?:从|自)([^到去至往导航路线]+)(?:到|去|至|往)...`),
        
        // "去 B" 模式
        regexp.MustCompile(`^(?:去|到|前往)([^导航路线怎]+)...`),
        
        // "帮我从 A 到 B" 模式
        regexp.MustCompile(`帮我?(?:从|自)([^到去至往]+)...`),
    }
    
    // 清理并匹配
    cleanText := strings.TrimSpace(text)
    // ... 匹配逻辑
}
```

---

## 🎯 实际使用场景

### 场景 1: 基础语音导航

**用户操作：**
1. 打开 Claude Desktop
2. 点击麦克风图标（或使用语音唤醒）
3. 说："从北京到上海"

**系统处理：**
```
[语音] "从北京到上海"
   ↓ (Claude STT)
[文字] "从北京到上海"
   ↓ (Claude 理解意图)
[调用] parse_navigation_intent("从北京到上海")
   ↓ (返回)
{
  "start": "北京",
  "end": "上海",
  "confidence": 0.9
}
   ↓ (Claude 调用)
[调用] navigate_map({
  "start": "北京",
  "end": "上海",
  "mapProvider": "baidu"
})
   ↓
[结果] 浏览器打开百度地图
```

### 场景 2: 详细地点语音导航

**用户说：**
> "帮我从北京天安门到上海东方明珠导航"

**Claude 显示：**
```
我来帮您规划路线。

[调用工具：parse_navigation_intent]
🔍 解析结果：
- 起点：北京天安门
- 终点：上海东方明珠
- 置信度：90%

[调用工具：navigate_map]
✅ 成功打开百度地图
📍 起点：北京天安门
📍 终点：上海东方明珠
```

### 场景 3: 指定地图提供商

**用户说：**
> "用高德地图从上海到杭州"

**系统识别：**
- 地图偏好：高德地图
- 起点：上海
- 终点：杭州

**执行：**
```go
navigate_map({
  "start": "上海",
  "end": "杭州",
  "mapProvider": "amap"  // 高德地图
})
```

### 场景 4: 不完整信息的语音输入

**用户说：**
> "去杭州西湖"

**Claude 响应：**
```
我注意到您想去杭州西湖。

[调用工具分析]
⚠️ 只识别到终点，起点未指定

请问您的出发地是哪里呢？
```

**用户继续说：**
> "从上海出发"

**Claude 理解上下文：**
```
好的，明白了！

[调用导航工具]
✅ 已打开百度地图
📍 起点：上海
📍 终点：杭州西湖
```

---

## 🌐 支持的语音表达方式

### 标准表达

| 语音输入 | 解析结果 | 支持 |
|----------|----------|------|
| "从北京到上海" | 起点：北京, 终点：上海 | ✅ |
| "从天安门去东方明珠" | 起点：天安门, 终点：东方明珠 | ✅ |
| "北京到上海导航" | 起点：北京, 终点：上海 | ✅ |
| "帮我从北京到上海" | 起点：北京, 终点：上海 | ✅ |

### 简化表达

| 语音输入 | 解析结果 | 支持 |
|----------|----------|------|
| "去杭州" | 终点：杭州 | ✅ (需补充起点) |
| "到上海浦东机场" | 终点：上海浦东机场 | ✅ (需补充起点) |
| "前往西湖" | 终点：西湖 | ✅ (需补充起点) |

### 带偏好的表达

| 语音输入 | 解析结果 | 支持 |
|----------|----------|------|
| "用高德地图从上海到杭州" | mapProvider: amap | ✅ |
| "百度地图帮我导航到西湖" | mapProvider: baidu | ✅ |
| "打开高德从这里去机场" | mapProvider: amap | ✅ |

---

## 🔍 语音识别优化建议

### 说话技巧

1. **清晰发音**
   - ✅ "从北京到上海"
   - ❌ "从...嗯...北京...那个...到上海"

2. **使用标准表达**
   - ✅ "从A到B"
   - ✅ "帮我从A去B"
   - ❌ "我想要...可能...从A...去B那边"

3. **避免方言**
   - ✅ 使用普通话
   - ⚠️ 方言可能识别不准

4. **说话速度**
   - ✅ 正常语速
   - ❌ 过快或过慢

### 环境建议

1. **安静环境**
   - 减少背景噪音
   - 避免嘈杂场所

2. **麦克风质量**
   - 使用质量好的麦克风
   - 保持适当距离

3. **网络连接**
   - 确保网络稳定
   - STT 需要网络连接

---

## 💻 开发者扩展指南

如果你想实现自己的语音识别功能：

### 方案 1: 集成第三方 STT 服务

可以在 MCP 服务器中添加 STT 功能：

```go
// 伪代码示例
package voice

import (
    "github.com/some-stt-library/stt"
)

// 添加语音输入工具
func AddVoiceTool(server *mcp.Server) {
    voiceTool := mcp.NewTool("voice_navigate",
        mcp.WithDescription("通过语音输入进行导航"),
        mcp.WithBinary("audio",
            mcp.Required(),
            mcp.Description("语音音频数据"),
        ),
    )
    
    server.AddTool(voiceTool, handleVoiceNavigate)
}

func handleVoiceNavigate(ctx context.Context, request mcp.CallToolRequest) (*mcp.CallToolResult, error) {
    // 1. 获取音频数据
    audioData := request.Params.Arguments["audio"]
    
    // 2. STT 转换
    text, err := stt.Recognize(audioData)
    if err != nil {
        return nil, err
    }
    
    // 3. 解析导航意图
    intent := parser.ParseNavigationIntent(text)
    
    // 4. 执行导航
    // ...
}
```

### 方案 2: 使用本地 STT 引擎

可选的开源 STT 引擎：

1. **Whisper (OpenAI)**
   - 高精度
   - 支持中文
   - 可本地部署

2. **DeepSpeech (Mozilla)**
   - 开源
   - 可训练
   - 支持多语言

3. **Vosk**
   - 轻量级
   - 离线可用
   - 支持中文

### 方案 3: 云端 API

可以集成云端语音服务：

- 百度语音识别
- 科大讯飞
- 阿里云 ASR
- 腾讯云 ASR

---

## 📊 语音识别准确率

### 当前通过 Claude 的准确率

| 场景 | 准确率 | 说明 |
|------|--------|------|
| 标准普通话 | 95%+ | Claude STT 质量很高 |
| 城市名称 | 98%+ | 常见地名识别好 |
| 地标名称 | 90%+ | 知名地标准确 |
| 复杂地址 | 85%+ | 可能需要重复 |

### 提高准确率的方法

1. **清晰表达**
   - 放慢语速
   - 标准发音

2. **使用常见地名**
   - "北京" 而不是 "京城"
   - "上海" 而不是 "魔都"

3. **重复关键信息**
   - 如果不准确，重新说一遍
   - 可以分步说明

---

## 🎭 实战演示

### 演示 1: 完整语音导航流程

```
👤 用户: [按下麦克风按钮]
👤 用户: [说话] "从北京天安门到上海东方明珠"

🤖 Claude: [语音识别]
📝 文字: "从北京天安门到上海东方明珠"

🤖 Claude: [理解意图]
💭 分析: 这是导航请求

🤖 Claude: [调用 MCP 工具]
🔧 工具: parse_navigation_intent
📥 输入: "从北京天安门到上海东方明珠"
📤 输出: {
  start: "北京天安门",
  end: "上海东方明珠",
  confidence: 0.9
}

🤖 Claude: [调用第二个工具]
🔧 工具: navigate_map
📥 输入: {
  start: "北京天安门",
  end: "上海东方明珠",
  mapProvider: "baidu"
}

🌐 浏览器: [自动打开]
🗺️ 百度地图: 显示导航路线

🤖 Claude: [语音回复]
🔊 "已为您打开百度地图，显示从北京天安门到上海东方明珠的导航路线。"
```

---

## ❓ 常见问题

### Q1: 为什么没有直接的语音输入接口？

**A:** 因为：
1. Claude Desktop 已经提供了优秀的 STT 功能
2. 避免重复开发
3. 保持系统简洁
4. 专注于核心的导航逻辑

### Q2: 可以用其他语音助手吗？

**A:** 可以！只要支持 MCP 协议的 AI 助手都可以：
- Claude Desktop ✅
- 其他支持 MCP 的 AI 客户端 ✅

### Q3: 语音识别不准确怎么办？

**A:** 解决方案：
1. 使用文字输入作为替代
2. 调整说话方式
3. 改善环境噪音
4. 重复输入

### Q4: 是否支持方言？

**A:** 取决于 AI 助手的 STT 能力：
- Claude STT: 主要支持普通话
- 其他方言: 可能识别不准

### Q5: 能否添加自定义语音命令？

**A:** 可以通过扩展正则表达式：

```go
// 在 pkg/parser/parser.go 中添加新模式
var navigationPatterns = []*regexp.Regexp{
    // 现有模式...
    
    // 自定义：语音快捷方式
    regexp.MustCompile(`回家`),  // 识别"回家"
    regexp.MustCompile(`去公司`),  // 识别"去公司"
}
```

---

## 🚀 未来增强

### 计划中的功能

1. **直接语音输入支持**
   - 集成 Whisper
   - 本地 STT 处理
   - 降低网络依赖

2. **语音反馈**
   - TTS (文字转语音)
   - 语音确认导航
   - 语音导航指引

3. **多语言支持**
   - 英文
   - 其他方言
   - 多语言混合

4. **智能记忆**
   - 记住常用地点
   - "回家"、"去公司" 等快捷命令
   - 个性化建议

---

## 📚 相关文档

- [`RUN_DEMO.md`](RUN_DEMO.md) - 运行演示
- [`USAGE.md`](USAGE.md) - 使用指南
- [`API.md`](API.md) - API 文档
- [`EXAMPLES.md`](EXAMPLES.md) - 更多示例

---

**总结：** 语音输入功能通过 AI 助手（如 Claude Desktop）的内置 STT 实现，我们的 MCP 服务器专注于文字解析和导航执行，这是一个优雅的分工协作方案！🎤
